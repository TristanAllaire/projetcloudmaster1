<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
	<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
	<link rel="stylesheet" href="css.css"/>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script> 
    <navbar-brand>Le Petit Cloud</navbar-brand>
  </head>

  <body>
  	<script src="https://unpkg.com/mithril/mithril.js"></script>
  	<script>
  	
  		var Verifier = {
  				petitionDuplicateName: function() {
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/listPetition/"+Petition.current.name,
	  		            withCredentials: true,
	  		        })
	  		        .then(function(result) {
	  		        	let okayToGo = true
	  		        	if(result!==null) okayToGo = false
	  		        	console.log("OKEY ? ", okayToGo)
						if(okayToGo){
  		                    Petition.save()
						} else alert("Une pétition du même nom existe déjà, veuillez changer de nom");
	  		        })
	  		    }, voteDuplicateEmail: function(email) {
  		        	let encodedContributor = encodeURIComponent(email);
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/listContributor/"+encodedContributor+"/"+Petition.current.name,
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	let okayToGo = true
	  		        	if(result!==null) okayToGo = false
	  		        	console.log("OKAY ? ", okayToGo)
						if(okayToGo){
  		                    Contributor.save()
  		                    Petition.loadList()
  		                } else {
  		                	alert("L'email que vous avez indiqué a déjà été utilisé pour signer cette pétition");
  		                }
	  		        })
	  		    },
  		}
	
	  	var Petition = {
	  		    list: [],
	  		    loadList: function() {
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entity",
	  		            withCredentials: true,
	  		        })
	  		        .then(function(result) {
	  		        	Petition.list = result.items
	  		        	console.log("got:",result.items)
	  		        	m.redraw(true) // force
	  		        })
	  		    },
	  		    current: {
	  		    	"name":"",
	  		    	"description":"",
	  		    	"email":""
	  		    },
	  		    load: function(id) {
	  		    	return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/listPetition/"+id,
	  		            withCredentials: true,
	  		    	}).then(function(result){
						if(result!==null){
		  		    		Petition.current = result.key
						}
	  		    	})
	  		    },
	  		    save: function() {
	  		    	console.log("saving...",Petition.current)
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/addPetition/"+
	  		            	Petition.current.name+"/"+
	  		            	Petition.current.description+"/"+
	  		            	Petition.current.email,
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	Petition.loadList()
		                m.route.set('/list')
	  		        })
	  		    },
				addAVote: function() {
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/addAVote/"+Petition.current.name,
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	Petition.loadList()
	  		        })
				},
				loadTopHundred: function(){
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entitycollection",
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	Petition.list = result.items
	  		        	console.log("got:",result.items)
	  		        	m.redraw(true) // force
	  		        })
				},
				votedForAContribu: [],
				loadfromcontributor: function(){
					let encodedContributor = encodeURIComponent(Contributor.current.email);
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/votedForContributor/"+encodedContributor,
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	votedForAContribu = []	  		        
	  		        	result.items.forEach((element) => {
	  		        		console.log("element ",element)
	  		        		Petition.votedForAContribu.push(element.properties.name)
	  		        	})
	  		        })
				}
	  		}
	  	
	  	var Contributor = {
	  		    list: [],
	  		    loadList: function() {
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entity",
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	Contributor.list = result.items
	  		        	console.log("got:",result.items)
	  		        	m.redraw(true) // force
	  		        })
	  		    },
	  		    current: {
	  		    	"name":"",
	  		    	"firstname":"",
	  		    	"lastname":"",
	  		    	"email":"",
	  		    	"zipcode":0,
	  		    	"city":"",
	  		    },
	  		    save: function() {
	  		    	console.log("saving...",Contributor.current)
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/voteForPetition/"+
	  		          	Contributor.current.name+"/"+
	  		          	Contributor.current.email+"/"+
	  		          	Contributor.current.firstname+"/"+
	  		          	Contributor.current.lastname+"/"+
	  		          	Contributor.current.zipcode+"/"+
	  		          	Contributor.current.city,
	  		            withCredentials: true
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	return m.request({
	  		        		method: "POST",
		  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/addAVote/"+result.properties.name,
		  		            withCredentials: true
	  		        	}).then(function(result) {
	  		        		console.log("résultat ",result)
	  		        		Contributor.loadList()
	  		        		m.route.set('/list')
	  		        	})
	  		        })
	  		    },
	  		    listContributorForAPetition: function(id) {
	  		    	return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entity/"+id,
	  		            withCredentials: true,
	  		    	}).then(function(result){
	  		    		Contributor.list = result
	  		    		console.log(result)
	  		    	})	
	  		    },
	  	}
	
	  	var PetitionView = {
	  			oninit: Petition.loadList,
	  		    view: function() {
	  		        return m(".user-list", Petition.list.map(function(item) {
	  		            return m("div.item", [
	  		            	m("a.user-list-item", {href:"/vote/"+item.properties.name, oncreate: m.route.link
	            			} ,item.properties.name),
							m("p", {class: "user-list-number-vote"}, item.properties.votecount),
							m("p", {class: "user-list-description"}, item.properties.description),
	            			m("span"," créée par "),
	            			m("a.user-list-item-author", {href:"/contributor/" + encodeURIComponent(item.properties.email), oncreate: m.route.link}, item.properties.email)
	            		])
	  		        }))
	  		    },
	  			
	  	}
	  	
	  	var HundredPetitionView = {
	  			oninit: Petition.loadTopHundred,
	  		    view: function() {
	  		        return m(".user-list", Petition.list.map(function(item) {
	  		            return m("div.item", [
	  		            	m("a.user-list-item", {href:"/vote/"+item.properties.name, oncreate: m.route.link
		            			} ,item.properties.name + " " + item.properties.votecount + " " + item.properties.description),
		            			m("span"," créée par "),
		            			m("a.user-list-item-author", {href:"/contributor/" + encodeURIComponent(item.properties.email), oncreate: m.route.link}, item.properties.email)
		            	])
	  		        }))
	  		    },
	  			
	  	}
	  	
	  	var ContributorPetitionView = {
	  		    view: function() {
	  		        return m(".user-list", Petition.votedForAContribu.map(function(item) {
	  		            return m("div.item", [
	  		            	m("a.user-list-item", {href:"/vote/"+item, oncreate: m.route.link
	  		            			} ,item)	  		            
	  		            	])
	  		        }))
	  		    },
	  			
	  	}
	
	
	  	var Form = {
	  			view: function() {
	  		        return m("form.form-group", {
	  		                onsubmit: function(e) {
	  		                    e.preventDefault()
	  		                    if(Petition.current.name.replace(/\s/g, "").length>0 &&
	  		                    		Petition.current.description.replace(/\s/g, "").length>0 &&
	  		                    		Petition.current.email.replace(/\s/g, "").length>0){
		  		                    Verifier.petitionDuplicateName()
	  		                    }
	  		                    else alert("Un des champs n'a pas été rempli")
	  		                }
	  		            }, [
	  		            m("label.label", "name"),
	  		            m("input.form-control[type=text][placeholder=nom]", {
	  		                oninput: function (e) {Petition.current.name=e.target.value},
	  		                value: Petition.current.name
	  		            }),
	  		            m("label.label", "description"),
	  		            m("input.form-control[type=text][placeholder=description]", {
	  		                oninput: function (e) {Petition.current.description=e.target.value},
	  		                value: Petition.current.description
	  		            }),
	  		            m("label.label", "email"),
	  		            m("input.form-control[type=email][placeholder=mail de l'auteur]", {
	  		                oninput: function (e) {Petition.current.email=e.target.value},
	  		                value: Petition.current.email
	  		            }),
	  		            m("button.button[type=submit]", {class: "btn btn-primary"}, "Créer"),
	  		        ])
	  		    }
	  	}
	  	
	  	var FormPetitionContrib = {
	  			view: function() {
	  		        return m("form", {
	  		                onsubmit: function(e) {
	  		                	Petition.loadfromcontributor()
	  		  		        	m.redraw(true) // force
	  		                }
	  		            }, [
	  		            m("label.label", "email"),
	  		            m("input.input[type=text][placeholder=email]", {
	  		                oninput: function (e) {Contributor.current.email=e.target.value},
	  		                value: Contributor.current.email
	  		            }),
	  		            m("button.button[type=submit]", {class: "btn btn-primary"}, "Charger")
	  		        ])
	  		    }
	  	}
	  	
	  	var FormContributor = {
	  			view: function() {	  				
	  		        return m("form", {
	  		                onsubmit: function(e) {
	  		                    e.preventDefault()
	  		                    if(Contributor.current.firstname.replace(/\s/g, "").length>0 &&
	  		                    		Contributor.current.lastname.replace(/\s/g, "").length>0 &&
	  		                    		Contributor.current.email.replace(/\s/g, "").length>0 &&
	  		                    		Contributor.current.zipcode.replace(/\s/g, "").length>0 &&
	  		                    		Contributor.current.city.replace(/\s/g, "").length>0){
		  		                    Verifier.voteDuplicateEmail(Contributor.current.email)
	  		                    }
	  		                    else alert("Un des champs n'a pas été rempli")
	  		                }
	  		            }, [
	  		          	m("label.label", "firstName"),
	  		            m("input.input[type=text][placeholder=Prénom]", {
	  		                oninput: function (e) {Contributor.current.firstname=e.target.value},
	  		                value: Contributor.current.firstname
	  		            }),
	  		          	m("label.label", "lastName"),
	  		            m("input.input[type=text][placeholder=Nom de famille]", {
	  		                oninput: function (e) {Contributor.current.lastname=e.target.value},
	  		                value: Contributor.current.lastname
	  		            }),
	  		          	m("label.label", "email"),
	  		            m("input.input[type=email][placeholder=email]", {
	  		                oninput: function (e) {Contributor.current.email=e.target.value},
	  		                value: Contributor.current.email
	  		            }),
	  		          	m("label.label", "zipCode"),
	  		            m("input.input[type=number][placeholder=Code postal]", {
	  		                oninput: function (e) {Contributor.current.zipcode=e.target.value},
	  		                value: Contributor.current.zipcode
	  		            }),
	  		          	m("label.label", "city"),
	  		            m("input.input[type=text][placeholder=Ville]", {
	  		                oninput: function (e) {Contributor.current.city=e.target.value},
	  		                value: Contributor.current.city
	  		            }),
	  		            m("button.button[type=submit]", {class: "btn btn-primary"}, "Save"),
	  		        ])
	  		    }
	  	}
	  	
	  	var ListPetitionPage = {
	  		    view: function() {
	  		    	return m("main", [
	  					m("nav", {class: "navbar navbar-default"}, [
						  m("a", {class: "navbar-brand"}, "TinyPet"),
						  	m("ul", {class: "nav navbar-nav"}, [
							  	m("li", {class: "nav-item active"}, m("a", {onclick: function(){
									m.route.set('/list');
									}}, "Liste des pétitions ouvertes")),
								m("li", {class: "nav-item "}, m("a", {onclick: function(){
									m.route.set('/top');
									}}, "Accéder au top 100 des meilleurs pétitions")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/contributor');
									}}, "Rechercher les signatures d'un contributeur")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/create');
									}}, "Créer une pétition"))
							])
						]),
						m("div", {id: "box"}, m(PetitionView))
	  		        ])
	  		    }
	  		}
	  	
	  	var CreatePetitionPage = {
	  		    view: function() {
	  		    	return m("main", [
					  m("nav", {class: "navbar navbar-default"}, [
					  m("a", {class: "navbar-brand"}, "TinyPet"),
						  	m("ul", {class: "nav navbar-nav"}, [
							  	m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/list');
									}}, "Liste des pétitions ouvertes")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/top');
									}}, "Accéder au top 100 des meilleurs pétitions")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/contributor');
									}}, "Rechercher les signatures d'un contributeur")),
								m("li", {class: "nav-item active"}, m("a", {onclick: function(){
									m.route.set('/create');
									}}, "Créer une pétition"))
							])
						]),
	  		            m("div", {id: "form"}, m(Form))
	  		        ])
	  		    }
	  		}
			  
/* TODO : Style votePage */	  	
	  	var VotePage = {
	  			oninit: function(vnode) {
	  				Petition.load(vnode.attrs.id)
	  				Contributor.current.name = vnode.attrs.id
	  			},
	  		    view: function() {
	  		    	return m("main", [
	  		            m("a", {class: "navbar-brand"}, "Voter pour une pétition"),
	  		            m("div", {id: "formcontributor"}, m(FormContributor)),
	  		            m("button", {onclick: function() {Contributor.listContributorForAPetition(Contributor.current.name)}},"Obtenir le nombre de votants pour cette pétition" )
	  		        ])
	  		    }
	  		}
	  	
	  	var CentPremierPage = {
	  		    view: function() {
	  		    	return m("main", [
					  m("nav", {class: "navbar navbar-default"}, [
					  m("a", {class: "navbar-brand"}, "TinyPet"),
						  	m("ul", {class: "nav navbar-nav"}, [
							  	m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/list');
									}}, "Liste des pétitions ouvertes")),
								m("li", {class: "nav-item active"}, m("a", {onclick: function(){
									m.route.set('/top');
									}}, "Accéder au top 100 des meilleurs pétitions")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/contributor');
									}}, "Rechercher les signatures d'un contributeur")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/create');
									}}, "Créer une pétition"))
							])
						]),
	  		            m("div", {id: "box"}, m(HundredPetitionView)),
	  		        ])
	  		    }
	  		}
	  	
	  	var PetitionFromContribPageSearch = {
	  		    view: function() {
	  		    	return m("main", [
					  m("nav", {class: "navbar navbar-default"}, [
					  m("a", {class: "navbar-brand"}, "TinyPet"),
						  	m("ul", {class: "nav navbar-nav"}, [
							  	m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/list');
									}}, "Liste des pétitions ouvertes")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/top');
									}}, "Accéder au top 100 des meilleurs pétitions")),
								m("li", {class: "nav-item active"}, m("a", {onclick: function(){
									m.route.set('/contributor');
									}}, "Rechercher les signatures d'un contributeur")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/create');
									}}, "Créer une pétition"))
							])
						]),,
	  		            m("div", {id: "box"}, m(ContributorPetitionView)),
	  		            m("div", {id: "form"}, m(FormPetitionContrib)),
	  		        ])
	  		    }
	  		}
  		
	  	var PetitionFromContribPage = {
	  			oninit: function(vnode) {
	  				Petition.load(vnode.attrs.id)
	  				Contributor.current.email = vnode.attrs.id
	                Petition.loadfromcontributor()
	  		       	m.redraw(true) // force
	  			},
	  		    view: function() {
	  		    	return m("main", [
					  m("nav", {class: "navbar navbar-default"}, [
					  m("a", {class: "navbar-brand"}, "TinyPet"),
						  	m("ul", {class: "nav navbar-nav"}, [
							  	m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/list');
									}}, "Liste des pétitions ouvertes")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/top');
									}}, "Accéder au top 100 des meilleurs pétitions")),
								m("li", {class: "nav-item active"}, m("a", {onclick: function(){
									m.route.set('/contributor');
									}}, "Rechercher les signatures d'un contributeur")),
								m("li", {class: "nav-item"}, m("a", {onclick: function(){
									m.route.set('/create');
									}}, "Créer une pétition"))
							])
						]),
	  		            m("div", {id: "box"}, m(ContributorPetitionView)),
	  		        ])
	  		    }
	  		}
	
	  	m.route(document.body, "/list", {
	  		"/list": ListPetitionPage,
	  		"/create": CreatePetitionPage,
	  		"/vote/:id": VotePage,
	  		"/top": CentPremierPage,
	  		"/contributor": PetitionFromContribPageSearch,
	  		"/contributor/:id": PetitionFromContribPage
	  	})	
	

  	</script>
  </body>
</html>