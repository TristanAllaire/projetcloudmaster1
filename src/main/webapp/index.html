<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <title>Le Petit Cloud</title>
  </head>

  <body>
  	<script src="https://unpkg.com/mithril/mithril.js"></script>
  	<script>
	
	  	var Petition = {
	  		    list: [],
	  		    loadList: function() {
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entity"
	  		        })
	  		        .then(function(result) {
	  		        	Petition.list = result.items
	  		        	console.log("got:",result.items)
	  		        	m.redraw(true) // force
	  		        })
	  		    },
	  		    current: {},
	  		    load: function(id) {
	  		    	return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/listPetition/"+id,
	  		            withCredentials: true,
	  		    	}).then(function(result){
	  		    		Petition.current = result.key
	  		    	})
	  		    },
	  		    save: function() {
	  		    	console.log("saving...",Petition.current)
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/addPetition/"+Petition.current.name
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	Petition.loadList()
	  		        })
	  		    },
				addAVote: function() {
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/addAVote/"+Petition.current.name
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	Petition.loadList()
	  		        })
				},
				loadTopHundred: function(){
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entitycollection"
	  		        })
	  		        .then(function(result) {
	  		        	Petition.list = result.items
	  		        	console.log("got:",result.items)
	  		        	m.redraw(true) // force
	  		        })
				},
				loadfromcontributor: function(){
					let encodedContributor = encodeURIComponent(Contributor.current.email);
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/votedForContributor/"+encodedContributor
	  		        })
	  		        .then(function(result) {
	  		        	console.log("Petitions du Contributor :",result.items)//////////TU ES RENDU LA
	  		        	m.redraw(true) // force
	  		        })
				}
	  		}
	  	
	  	var Contributor = {
	  		    list: [],
	  		    loadList: function() {
	  		        return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entity"
	  		        })
	  		        .then(function(result) {
	  		        	Contributor.list = result.items
	  		        	console.log("got:",result.items)
	  		        	m.redraw(true) // force
	  		        })
	  		    },
	  		    current: {},
	  		    save: function() {
	  		    	console.log("saving...",Contributor.current)
	  		        return m.request({
	  		            method: "POST",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/voteForPetition/"+
	  		          	Contributor.current.name+"/"+
	  		          	Contributor.current.email+"/"+
	  		          	Contributor.current.firstname+"/"+
	  		          	Contributor.current.lastname+"/"+
	  		          	Contributor.current.zipcode+"/"+
	  		          	Contributor.current.city
	  		        })
	  		        .then(function(result) {
	  		        	console.log("got:",result)
	  		        	return m.request({
	  		        		method: "POST",
		  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/addAVote/"+result.properties.name
	  		        	}).then(function(result) {
	  		        		console.log("résultat ",result)
	  		        		Contributor.loadList()
	  		        	})
	  		        })
	  		    },
	  		    listContributorForAPetition: function(id) {
	  		    	return m.request({
	  		            method: "GET",
	  		            url: "https://lepetitcloud.appspot.com/_ah/api/petitions/v1/entity/"+id,
	  		            withCredentials: true,
	  		    	}).then(function(result){
	  		    		Contributor.list = result
	  		    		console.log(result)
	  		    	})	
	  		    },
	  	}
	
	  	var PetitionView = {
	  			oninit: Petition.loadList,
	  		    view: function() {
	  		        return m(".user-list", Petition.list.map(function(item) {
	  		            return m("div.item", [
	  		            	m("a.user-list-item", {href:"/vote/"+item.properties.name, oncreate: m.route.link
	  		            			} ,item.properties.name + " " + item.properties.votecount)	  		            
	  		            	])
	  		        }))
	  		    },
	  			
	  	}
	  	
	  	var HundredPetitionView = {
	  			oninit: Petition.loadTopHundred,
	  		    view: function() {
	  		        return m(".user-list", Petition.list.map(function(item) {
	  		            return m("div.item", [
	  		            	m("a.user-list-item", {href:"/vote/"+item.properties.name, oncreate: m.route.link
	  		            			} ,item.properties.name + " " + item.properties.votecount)	  		            
	  		            	])
	  		        }))
	  		    },
	  			
	  	}
	  	
	  	var ContributorPetitionView = {
	  		    view: function() {
	  		        return m(".user-list", Petition.list.map(function(item) {
	  		            return m("div.item", [
	  		            	m("a.user-list-item", {href:"/vote/"+item.properties.name, oncreate: m.route.link
	  		            			} ,item.properties.name + " " + item.properties.votecount)	  		            
	  		            	])
	  		        }))
	  		    },
	  			
	  	}
	
	
	  	var Form = {
	  			view: function() {
	  		        return m("form", {
	  		                onsubmit: function(e) {
	  		                    e.preventDefault()
	  		                    Petition.save()
	  		                }
	  		            }, [
	  		            m("label.label", "name"),
	  		            m("input.input[type=text][placeholder=name]", {
	  		                oninput: function (e) {Petition.current.name=e.target.value},
	  		                value: Petition.current.name
	  		            }),
	  		            m("button.button[type=submit]", "Save"),
	  		        ])
	  		    }
	  	}
	  	
	  	var FormPetitionContrib = {
	  			view: function() {
	  		        return m("form", {
	  		                onsubmit: function(e) {
	  		                    e.preventDefault()
	  		                    Petition.save()
	  		                }
	  		            }, [
	  		            m("label.label", "email"),
	  		            m("input.input[type=text][placeholder=email]", {
	  		                oninput: function (e) {Contributor.current.email=e.target.value},
	  		                value: Petition.current.email
	  		            }),
	  		            m("button.button",{onclick: function(){
	  		            	Petition.loadfromcontributor()
	  		            }}, "Charger")
	  		        ])
	  		    }
	  	}
	  	
	  	var FormContributor = {
	  			view: function() {	  				
	  		        return m("form", {
	  		                onsubmit: function(e) {
	  		                    e.preventDefault()
	  		                    Contributor.save()
	  		                	m.route.set('/list');
	  		                }
	  		            }, [
	  		          	m("label.label", "firstName"),
	  		            m("input.input[type=text][placeholder=Prénom]", {
	  		                oninput: function (e) {Contributor.current.firstname=e.target.value},
	  		                value: Contributor.current.firstname
	  		            }),
	  		          	m("label.label", "lastName"),
	  		            m("input.input[type=text][placeholder=Nom de famille]", {
	  		                oninput: function (e) {Contributor.current.lastname=e.target.value},
	  		                value: Contributor.current.lastname
	  		            }),
	  		          	m("label.label", "email"),
	  		            m("input.input[type=email][placeholder=Nom de famille]", {
	  		                oninput: function (e) {Contributor.current.email=e.target.value},
	  		                value: Contributor.current.email
	  		            }),
	  		          	m("label.label", "zipCode"),
	  		            m("input.input[type=number][placeholder=Code postal]", {
	  		                oninput: function (e) {Contributor.current.zipcode=e.target.value},
	  		                value: Contributor.current.zipcode
	  		            }),
	  		          	m("label.label", "city"),
	  		            m("input.input[type=text][placeholder=Ville]", {
	  		                oninput: function (e) {Contributor.current.city=e.target.value},
	  		                value: Contributor.current.city
	  		            }),
	  		            m("button.button[type=submit]", "Save"),
	  		        ])
	  		    }
	  	}
	  	
	  	var ListPetitionPage = {
	  		    view: function() {
	  		    	return m("main", [
	  		            m("h1", {class: "title"}, "Liste des pétitions ouvertes"),
	  		            m("div", {id: "box"}, m(PetitionView)),
	  		            m("div", {id: "form"}, m(Form)),
	  		            m("button", {onclick: function(){
  		                	m.route.set('/top');
	  		            }}, "Accéder au top 100 des meilleurs pétitions"),
	  		            m("button", {onclick: function(){
  		                	m.route.set('/contributor');
	  		            }}, "Rechercher les signatures d'un contributeur")
	  		        ])
	  		    }
	  		}
	  	
	  	var CreatePetitionPage = {
	  		    view: function() {
	  		    	return m("main", [
	  		            m("h1", {class: "title"}, "Création d'une pétition"),
	  		        ])
	  		    }
	  		}
	  	
	  	var VotePage = {
	  			oninit: function(vnode) {
	  				Petition.load(vnode.attrs.id)
	  				Contributor.current.name = vnode.attrs.id
	  			},
	  		    view: function() {
	  		    	return m("main", [
	  		            m("h1", {class: "title"}, "Voter pour une pétition"),
	  		            m("div", {id: "formcontributor"}, m(FormContributor)),
	  		            m("button", {onclick: function() {Contributor.listContributorForAPetition(Contributor.current.name)}},"Obtenir le nombre de votants pour cette pétition" )
	  		        ])
	  		    }
	  		}
	  	
	  	var CentPremierPage = {
	  		    view: function() {
	  		    	return m("main", [
	  		            m("h1", {class: "title"}, "Liste des 100 meilleures pétitions"),
	  		            m("div", {id: "box"}, m(HundredPetitionView)),
	  		        ])
	  		    }
	  		}
	  	
	  	var PetitionFromContribPage = {
	  		    view: function() {
	  		    	return m("main", [
	  		            m("h1", {class: "title"}, "Liste des pétitions signées pour un signataire"),
	  		            m("div", {id: "box"}, m(ContributorPetitionView)),
	  		            m("div", {id: "form"}, m(FormPetitionContrib)),
	  		        ])
	  		    }
	  		}
	
	  	m.route(document.body, "/list", {
	  		"/list": ListPetitionPage,
	  		"/create": CreatePetitionPage,
	  		"/vote/:id": VotePage,
	  		"/top": CentPremierPage,
	  		"/contributor": PetitionFromContribPage
	  	})	
	

  	</script>
  </body>
</html>